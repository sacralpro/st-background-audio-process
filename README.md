# Background Audio Processor for Sacral Track

## Обзор

Этот репозиторий содержит систему фоновой обработки аудио для приложения Sacral Track. Система полностью автоматически обрабатывает загруженные WAV аудиофайлы, конвертирует их в MP3 и создает HLS сегменты для потокового воспроизведения без какого-либо взаимодействия с пользователем.

## Что реализовано

1. **Appwrite Function** - основной компонент, выполняющий обработку аудио:
   - Полностью автоматический запуск после создания поста с аудиофайлом
   - Конвертация WAV → MP3 (192k битрейт)
   - Создание HLS сегментов и плейлиста (streaming)
   - Загрузка обработанных файлов обратно в Appwrite Storage
   - Фоновое обновление документа поста с новыми ссылками

2. **Автоматическая интеграция** - не требует никаких действий со стороны пользователя:
   - Обработка запускается автоматически после загрузки WAV файла
   - Пользователи Sacral Track не видят процесс обработки
   - Готовые файлы автоматически становятся доступными для воспроизведения

3. **Логирование для разработчиков**:
   - Подробное логирование каждого этапа процесса в консоли Appwrite
   - Обновление полей статуса в документе поста для отладки
   - Обработка ошибок и системные уведомления для разработчиков

## Архитектура системы

```
┌─────────────────┐     ┌───────────────────┐     ┌─────────────────┐
│                 │     │                   │     │                 │
│  Sacral Track   │────▶│ Appwrite Function │────▶│ Appwrite Storage│
│  (Next.js app)  │     │ (Audio Processor) │     │  (Files)        │
│                 │     │                   │     │                 │
└─────────────────┘     └───────────────────┘     └─────────────────┘
         │                       │                         │
         │                       │                         │
         └───────────────────────▼─────────────────────────┘
                        ┌──────────────────┐
                        │   Appwrite DB    │
                        │   (Posts data)   │
                        └──────────────────┘
```

## Настройка Appwrite Function

### 1. Деплой функции

1. В [Appwrite Console](https://cloud.appwrite.io) перейдите в Functions
2. Создайте новую функцию:
   - Name: Background audio processor for Sacral Track
   - Runtime: Node.js 22
   - Timeout: 900 seconds (максимум)
   - Entrypoint: src/appwriteFunction.js

3. Подключите Git репозиторий:
   - Repository URL: https://github.com/sacralpro/st-background-audio-process
   - Branch: master
   - Root directory: / (корень)
   - Build command: npm install

### 2. Настройка разрешений (Scopes)

В настройках функции обязательно добавьте следующие разрешения:
- **Database**: Read и Write
- **Storage**: Read и Write
- **Auth**: Read (минимум)

### 3. Переменные окружения

Добавьте необходимые переменные окружения:
```
APPWRITE_DATABASE_ID=67f225f50010cced7742
APPWRITE_COLLECTION_ID_POST=67f22813001f125cc1e5
APPWRITE_BUCKET_ID=67f2239600384003fd78
```

### 4. Настройка автоматического запуска

В консоли Appwrite настройте триггеры для автоматического запуска функции:

1. Перейдите в раздел Functions → Выберите созданную функцию → Вкладка Settings → Events
2. Добавьте следующие триггеры для событий:
   - `databases.[DATABASE_ID].collections.[COLLECTION_ID].documents.create`
   - `databases.[DATABASE_ID].collections.[COLLECTION_ID].documents.update`

Теперь функция будет запускаться автоматически при создании или обновлении документа поста.

## Как это работает в Sacral Track

### 1. Стандартная загрузка поста с аудио

Пользователь работает со стандартным интерфейсом Sacral Track:
- Создает новый пост
- Загружает WAV аудиофайл
- Заполняет необходимые данные поста
- Нажимает кнопку "Опубликовать"

### 2. Автоматическая фоновая обработка

Весь процесс обработки происходит в фоне без отображения пользователю:
- WAV файл сохраняется в Appwrite Storage
- Создается документ поста со ссылкой на WAV файл
- Автоматически запускается функция обработки аудио через событие создания документа
- Функция обрабатывает аудио и обновляет документ поста с новыми ссылками
- После завершения обработки MP3 и HLS файлы становятся доступными для воспроизведения

### 3. Результат для пользователя

Пользователь видит только конечный результат:
- Стандартный пост с аудиоплеером
- Возможность воспроизведения аудио в MP3 формате
- Потоковое воспроизведение для медленных соединений

## Как функция работает (для разработчиков)

1. **Инициирование процесса**:
   - Срабатывает триггер после создания документа поста с аудиофайлом
   - Функция извлекает ID поста из события

2. **Обработка аудио**:
   - Функция получает документ поста из базы данных
   - Скачивает исходный WAV файл во временную директорию
   - Конвертирует WAV в MP3 с битрейтом 192k
   - Загружает MP3 в Appwrite Storage
   - Создает HLS сегменты и плейлист для потокового воспроизведения
   - Загружает сегменты и плейлист в Storage
   - Обновляет документ поста с новыми ссылками

3. **Логирование процесса (только для разработчиков)**:
   - На каждом этапе функция записывает информацию в логи Appwrite
   - Обновляет служебные поля в документе для отслеживания прогресса
   - Эта информация не отображается пользователям, но доступна разработчикам для отладки

## Поля документа поста (для разработчиков)

Процесс обработки добавляет следующие поля в документ поста (используются только системой):

- `processing_status`: статус обработки (pending, processing, completed, failed)
- `processing_progress`: текущий этап обработки (текстовое описание)
- `mp3_url`: URL для MP3 версии аудио
- `m3u8_url`: URL для M3U8 плейлиста (потоковое воспроизведение)
- `segments`: список ID сегментов HLS
- `streaming_urls`: список URL для сегментов HLS
- `processing_started_at`: временная метка начала обработки
- `processing_completed_at`: временная метка завершения обработки
- `processing_error`: описание ошибки (если возникла)

## Устранение неполадок (для разработчиков)

1. **Функция завершается по таймауту**:
   - Увеличьте максимальное время выполнения функции до 900 секунд
   - Проверьте размер обрабатываемых файлов (очень большие файлы могут превышать лимиты)

2. **Ошибки прав доступа**:
   - Убедитесь, что функция имеет необходимые разрешения (Database и Storage)
   - Проверьте правильность ID базы данных, коллекции и бакета

3. **Функция не запускается автоматически**:
   - Проверьте настройки триггеров событий в консоли Appwrite
   - Убедитесь, что ID базы данных и коллекции указаны правильно

## Мониторинг (для разработчиков)

Для отслеживания работы системы используйте:

1. **Логи функции** - доступны в консоли Appwrite в разделе Functions → Executions
2. **Состояние документов** - проверяйте поля `processing_status` и `processing_progress`
3. **Метрики выполнения** - информация о времени выполнения и потреблении ресурсов

## Дополнительные материалы

- [Документация Appwrite Functions](https://appwrite.io/docs/products/functions)
- [Документация FFmpeg](https://ffmpeg.org/documentation.html)
- [HLS Streaming Guide](https://developer.apple.com/documentation/http-live-streaming)

## Контакты

По вопросам, связанным с этим репозиторием, обращайтесь к команде Sacral Projects.

---

Разработано Sacral Projects © 2025

# Тестирование Appwrite функции обработки аудио

Это руководство описывает способы тестирования функции обработки аудио в Appwrite.

## Подготовка к тестированию

1. Убедитесь, что у вас установлены все зависимости:

```bash
npm install
```

2. Создайте файл `.env` на основе `.env.example` и заполните его вашими данными:

```bash
cp .env.example .env
```

3. Отредактируйте файл `.env`, добавив свои значения для подключения к Appwrite.

## Способы тестирования

### 1. Локальное тестирование (без деплоя)

Этот метод позволяет тестировать функцию локально перед загрузкой в Appwrite:

```bash
node test-local.js
```

### 2. Тестирование через Appwrite API

После деплоя вашей функции в Appwrite, вы можете тестировать ее через API:

```bash
# Добавьте APPWRITE_FUNCTION_ID и TEST_POST_ID в ваш .env файл
node test-api.js
```

### 3. Тестирование с помощью Appwrite CLI

Установите Appwrite CLI и используйте его для тестирования:

```bash
npm install -g appwrite-cli
appwrite login
appwrite functions createExecution --functionId=[ID_ФУНКЦИИ] --data='{"postId":"[ID_ПОСТА]"}'
```

### 4. Тестирование через Appwrite Console

1. Войдите в [Appwrite Console](https://cloud.appwrite.io/console)
2. Перейдите в раздел Functions
3. Выберите вашу функцию
4. Нажмите кнопку "Execute Now"
5. Введите данные для тестирования в JSON формате:
   ```json
   {
     "postId": "ваш_идентификатор_поста"
   }
   ```
6. Нажмите "Execute" и проверьте результаты выполнения

## Проверка результатов

После выполнения функции проверьте:

1. Обновление документа в коллекции Posts
2. Наличие созданных файлов аудио-сегментов в Bucket
3. Генерацию плейлиста
4. Правильность статусов обработки

## Отладка

Для отладки используйте логи:

1. Через Appwrite Console: Functions > Ваша функция > Executions > Выберите конкретное выполнение > Logs
2. Через CLI: `appwrite functions listExecutions --functionId=[ID_ФУНКЦИИ]` и затем `appwrite functions getExecution --functionId=[ID_ФУНКЦИИ] --executionId=[ID_ВЫПОЛНЕНИЯ]` 